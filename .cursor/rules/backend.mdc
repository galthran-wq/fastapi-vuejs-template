---
description: "FastAPI backend conventions"
globs: ["server/**/*.py"]
alwaysApply: false
---

# Backend Conventions

## Stack
Python 3.12, FastAPI, async SQLAlchemy 2.0 + asyncpg, Alembic, pydantic-settings, structlog, uv

## Structure
- `src/main.py` — app factory (`create_app()`)
- `src/core/config.py` — pydantic Settings, SECRET_KEY validated at startup
- `src/core/database.py` — async engine with pooling, `get_postgres_session` dependency
- `src/core/auth.py` — JWT auth, `get_current_user` / `get_current_superuser`
- `src/core/exceptions.py` — `AppError(status_code, detail)`
- `src/core/middleware.py` — CORS (outermost), logging, request ID (innermost)
- `src/api/` — routers, aggregated in `src/api/router.py`
- `src/models/postgres/` — SQLAlchemy models (register in `__init__.py`)
- `src/repositories/` — abstract base + implementations
- `src/schemas/` — Pydantic request/response models

## Key Patterns
- Use `Depends(get_postgres_session)` for DB sessions
- Use `Depends(get_current_user)` for auth-protected endpoints
- Raise `AppError(status_code=400, detail="message")` for business errors
- Use `structlog.get_logger()`, never `logging.getLogger()`
- Package management: uv + pyproject.toml (not pip)

## Code Style
- ruff: line-length=120, target py312, isort with `src = ["src"]`
- Import order: stdlib → third-party (no blank lines between them) → first-party (`src.*`)
- mypy strict mode
- async-first, fully type-annotated
